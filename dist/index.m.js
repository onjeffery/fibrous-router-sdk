import{uint256 as t}from"starknet";const e=(t,e)=>`${t}?${Object.keys(e).map(t=>`${t}=${e[t]}`).join("&")}`,o=t=>{const e={};return null!=t&&(e["X-API-Key"]=t),e},r=t=>Number(t.replace("%","")),s=t=>String(Math.floor(1e6*Number(t.toFixed(4))));function n(e,o,n){const c=10**6,i=e=>{const o=t.bnToUint256(e);return[o.low,o.high]},a=[];let u=100;for(const t of e.route){const e=r(t.percent),o=e/u;u-=e;for(let e=0;e<t.swaps.length;e++){const n=t.swaps[e];let c=0==e?o:1,i=100;for(const t of n){const e=r(t.percent),o=e/i*c;i-=e,a.push([t.fromTokenAddress,t.toTokenAddress,s(o),String(t.protocol),t.poolAddress])}}}const p=BigInt(e.outputAmount)*BigInt((1-o)*c)/BigInt(c);return[String(a.length),...a.flat(),e.inputToken.address,e.outputToken.address,...i(e.inputAmount),...i(p),n]}class c{constructor(t,e){this.DEFAULT_API_URL="https://api.fibrous.finance",this.ROUTER_ADDRESS="0x1b23ed400b210766111ba5b1e63e33922c6ba0c45e6ad56ce112e5f4c578e62",this.apiUrl=void 0,this.apiKey=void 0,t&&t.endsWith("/")&&(t=t.substring(0,t.length-1)),this.apiUrl=t??this.DEFAULT_API_URL,this.apiKey=e??null}getBestRoute(t,r,s,n){try{const c=this,i={amount:t,tokenInAddress:r,tokenOutAddress:s};for(const[t,e]of Object.entries(n??{}))"excludeProtocols"!=t?i[t]=e:i.excludeProtocols=e.join(",");const a=e(`${c.apiUrl}/route`,i);return Promise.resolve(fetch(a,{headers:o(c.apiKey)}).then(t=>t.json()))}catch(t){return Promise.reject(t)}}supportedTokens(){try{const t=this;return Promise.resolve(fetch(`${t.apiUrl}/tokens`,{headers:o(t.apiKey)}).then(t=>t.json())).then(function(t){return t.reduce((t,e)=>Object.assign(t,{[e.symbol]:e}),{})})}catch(t){return Promise.reject(t)}}supportedProtocols(){try{const t=this;return Promise.resolve(fetch(`${t.apiUrl}/protocols`,{headers:o(t.apiKey)}).then(t=>t.json())).then(function(t){return t.reduce((t,e,o)=>Object.assign(t,{[e]:o+1}),{})})}catch(t){return Promise.reject(t)}}buildTransaction(t,e,o){return{contractAddress:this.ROUTER_ADDRESS,entryPoint:"swap",call_data:n(t,e,o)}}}const i={mySwap:1,JediSwap:2,"10K Swap":3,SithSwap:4};export{i as Protocols,c as Router,o as buildHeaders,e as buildRouteUrl,n as buildSwapCalldata,s as parsePercent,r as trimPercent};
